<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap");

      :root {
        --header-height: 3rem;
        --nav-width: 68px;
        --first-color: #4723d9;
        --first-color-light: #afa5d9;
        --white-color: #f7f6fb;
        --body-font: "Nunito", sans-serif;
        --normal-font-size: 1rem;
        --z-fixed: 100;
      }

      *,
      ::before,
      ::after {
        box-sizing: border-box;
      }

      body {
        position: relative;
        margin: var(--header-height) 0 0 0;
        padding: 0 1rem;
        font-family: var(--body-font);
        font-size: var(--normal-font-size);
        transition: 0.5s;
      }

      a {
        text-decoration: none;
      }

      .header {
        width: 100%;
        height: var(--header-height);
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        background-color: var(--white-color);
        z-index: var(--z-fixed);
        transition: 0.5s;
      }

      .header_toggle {
        color: var(--first-color);
        font-size: 1.5rem;
        cursor: pointer;
      }

      .header_img {
        width: 35px;
        height: 35px;
        display: flex;
        justify-content: center;
        border-radius: 50%;
        overflow: hidden;
      }

      .header_img img {
        width: 40px;
      }

      .l-navbar {
        position: fixed;
        top: 0;
        left: -30%;
        width: var(--nav-width);
        height: 100vh;
        background-color: var(--first-color);
        padding: 0.5rem 1rem 0 0;
        transition: 0.5s;
        z-index: var(--z-fixed);
      }

      .nav {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden;
      }

      .nav_logo,
      .nav_link {
        display: grid;
        grid-template-columns: max-content max-content;
        align-items: center;
        column-gap: 1rem;
        padding: 0.5rem 0 0.5rem 1.5rem;
      }

      .nav_logo {
        margin-bottom: 2rem;
      }

      .nav_logo-icon {
        font-size: 1.25rem;
        color: var(--white-color);
      }

      .nav_logo-name {
        color: var(--white-color);
        font-weight: 700;
      }

      .nav_link {
        position: relative;
        color: var(--first-color-light);
        margin-bottom: 1.5rem;
        transition: 0.3s;
      }

      .nav_link:hover {
        color: var(--white-color);
      }

      .nav_icon {
        font-size: 1.25rem;
      }

      .show {
        left: 0;
      }

      .body-pd {
        padding-left: calc(var(--nav-width) + 1rem);
      }

      .active {
        color: var(--white-color);
      }

      .active::before {
        content: "";
        position: absolute;
        left: 0;
        width: 2px;
        height: 32px;
        background-color: var(--white-color);
      }

      .height-100 {
        height: 100vh;
      }

      @media screen and (min-width: 768px) {
        body {
          margin: calc(var(--header-height) + 1rem) 0 0 0;
          padding-left: calc(var(--nav-width) + 2rem);
        }

        .header {
          height: calc(var(--header-height) + 1rem);
          padding: 0 2rem 0 calc(var(--nav-width) + 2rem);
        }

        .header_img {
          width: 40px;
          height: 40px;
        }

        .header_img img {
          width: 45px;
        }

        .l-navbar {
          left: 0;
          padding: 1rem 1rem 0 0;
        }

        .show {
          width: calc(var(--nav-width) + 156px);
        }

        .body-pd {
          padding-left: calc(var(--nav-width) + 188px);
        }
      }

      .logout {
        margin-top: auto;
      }

      /* Custom styles for the dashboard content */
      .status-card {
        cursor: pointer;
        transition: transform 0.2s;
      }

      .status-card:hover {
        transform: translateY(-5px);
      }

      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }
    </style>
  </head>

  <body id="body-pd">
    <header class="header" id="header">
      <div class="header_toggle">
        <i class="bx bx-menu" id="header-toggle"></i>
      </div>
    </header>

    <div class="l-navbar" id="nav-bar">
      <nav class="nav">
        <div>
          <a href="#" class="nav_logo">
            <img
              src="/assets/puplogo.png"
              alt="PFRS Logo"
              class="nav_logo-icon"
            />
            <span class="nav_logo-name">PFRS</span>
          </a>

          <div class="nav_list">
            <a href="/dashboards/property-admin/home.html" class="nav_link">
              <i class="bx bx-home nav_icon"></i>
              <span class="nav_name">Home</span>
            </a>
            <a
              href="/dashboards/property-admin/reservation-history/reservation-history.html"
              class="nav_link"
            >
              <i class="bx bx-calendar-event nav_icon"></i>
              <span class="nav_name">Reservation History</span>
            </a>
            <a
              href="/dashboards/property-admin/approval/approval.html"
              class="nav_link"
            >
              <i class="bx bx-check nav_icon"></i>
              <span class="nav_name">Approval</span>
            </a>
            <a
              href="/dashboards/property-admin/dashboard/dashboard.html"
              class="nav_link active"
            >
              <i class="bx bx-grid-alt nav_icon"></i>
              <span class="nav_name">Dashboard</span>
            </a>
            <a
              href="/dashboards/property-admin/property-inventory/property-inventory.html"
              class="nav_link"
            >
              <i class="bx bx-chair nav_icon"></i>
              <span class="nav_name">Property Inventory</span>
            </a>
            <a
              href="/dashboards/property-admin/manage-accounts/manage-accounts.html"
              class="nav_link"
            >
              <i class="bx bx-user nav_icon"></i>
              <span class="nav_name">Manage Account</span>
            </a>
            <a
              href="/dashboards/property-admin/announcement/announcement.html"
              class="nav_link"
            >
              <i class="fas fa-bullhorn nav_icon"></i>
              <span class="nav_name">Announcement</span>
            </a>
          </div>

          <div class="logout">
            <a href="#" class="nav_link">
              <i class="bx bx-log-out nav_icon"></i>
              <span class="nav_name">Sign Out</span>
            </a>
          </div>
        </div>
      </nav>
    </div>

    <main class="container-fluid mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Facility Admin Dashboard</h2>
        <button class="btn btn-primary" onclick="generateReports()">
          <i class="fas fa-download me-2"></i>Generate Report
        </button>
      </div>

      <!-- Summary Cards -->
      <div class="row mb-4" id="summaryCards">
        <div class="col-md-3">
          <div class="card text-white bg-primary mb-3 status-card">
            <div class="card-body">
              <h5>Total</h5>
              <p class="card-text fs-3" id="totalCount">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-warning mb-3 status-card">
            <div class="card-body">
              <h5>Pending</h5>
              <p class="card-text fs-3" id="pendingCount">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success mb-3 status-card">
            <div class="card-body">
              <h5>Approved</h5>
              <p class="card-text fs-3" id="approvedCount">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-danger mb-3 status-card">
            <div class="card-body">
              <h5>Rejected/Cancelled</h5>
              <p class="card-text fs-3" id="rejectedCount">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Analytics Charts Row -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Most Used Facilities</h5>
              <div class="chart-container chart-small">
                <canvas id="facilitiesChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Top Organizations</h5>
              <div class="chart-container chart-small">
                <canvas id="organizationsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Academic vs Non-Academic</h5>
              <div class="chart-container chart-small">
                <canvas id="academicChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
      let reservations = [];
      let facilities = [];

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        initializeNavbar();
        loadData();
      });

      function initializeNavbar() {
        const toggle = document.getElementById("header-toggle");
        const nav = document.getElementById("nav-bar");
        const bodypd = document.getElementById("body-pd");
        const headerpd = document.getElementById("header");

        if (toggle) {
          toggle.addEventListener("click", () => {
            nav.classList.toggle("show");
            toggle.classList.toggle("bx-x");
            bodypd.classList.toggle("body-pd");
            headerpd.classList.toggle("body-pd");
          });
        }
      }

      // Load data from collections
      async function loadData() {
        try {
          await Promise.all([loadReservations(), loadFacilities()]);
          updateDashboard();
        } catch (error) {
          console.error("Error loading data:", error);
          // Use sample data if database connection fails
          loadSampleData();
          updateDashboard();
        }
      }

      // Load reservations from database
      async function loadReservations() {
        try {
          // Replace with your actual API endpoint
          const response = await fetch("/api/reservations");
          if (response.ok) {
            reservations = await response.json();
          } else {
            throw new Error("Failed to load reservations");
          }
        } catch (error) {
          console.error("Error loading reservations:", error);
          throw error;
        }
      }

      // Load facilities from database
      async function loadFacilities() {
        try {
          // Replace with your actual API endpoint
          const response = await fetch("/api/facilities");
          if (response.ok) {
            facilities = await response.json();
          } else {
            throw new Error("Failed to load facilities");
          }
        } catch (error) {
          console.error("Error loading facilities:", error);
          throw error;
        }
      }

      // Sample data for demonstration
      function loadSampleData() {
        reservations = [
          {
            id: 1,
            eventName: "Academic Conference",
            facility: "Conference Hall A",
            organization: "Computer Science Department",
            startTime: "2025-06-15T09:00:00",
            endTime: "2025-06-15T17:00:00",
            status: "approved",
            personInCharge: "Dr. Smith",
            type: "academic",
          },
          {
            id: 2,
            eventName: "Student Seminar",
            facility: "Seminar Room B",
            organization: "Engineering Society",
            startTime: "2025-06-16T14:00:00",
            endTime: "2025-06-16T16:00:00",
            status: "pending",
            personInCharge: "John Doe",
            type: "academic",
          },
          {
            id: 3,
            eventName: "Workshop",
            facility: "Lab Room C",
            organization: "Business Club",
            startTime: "2025-06-17T10:00:00",
            endTime: "2025-06-17T12:00:00",
            status: "rejected",
            personInCharge: "Jane Smith",
            type: "non-academic",
          },
        ];

        facilities = [
          {
            id: 1,
            name: "Conference Hall A",
            capacity: 100,
            type: "conference",
          },
          { id: 2, name: "Seminar Room B", capacity: 50, type: "seminar" },
          { id: 3, name: "Lab Room C", capacity: 30, type: "laboratory" },
        ];
      }

      // Update dashboard with loaded data
      function updateDashboard() {
        updateSummaryCards();
        renderCharts();
      }

      // Update summary cards
      function updateSummaryCards() {
        const total = reservations.length;
        const pending = reservations.filter(
          (r) => r.status === "pending"
        ).length;
        const approved = reservations.filter(
          (r) => r.status === "approved"
        ).length;
        const rejected = reservations.filter(
          (r) => r.status === "rejected" || r.status === "cancelled"
        ).length;

        document.getElementById("totalCount").textContent = total;
        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("approvedCount").textContent = approved;
        document.getElementById("rejectedCount").textContent = rejected;
      }

      function renderCharts() {
        renderFacilitiesChart();
        renderOrganizationsChart();
        renderAcademicChart();
      }

      function renderFacilitiesChart() {
        const facilityCount = {};
        reservations.forEach((r) => {
          facilityCount[r.facility] = (facilityCount[r.facility] || 0) + 1;
        });

        const sortedFacilities = Object.entries(facilityCount)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 5);

        const ctx = document.getElementById("facilitiesChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: sortedFacilities.map(([name]) => name),
            datasets: [
              {
                label: "Reservations",
                data: sortedFacilities.map(([, count]) => count),
                backgroundColor: [
                  "#4723d9",
                  "#28a745",
                  "#ffc107",
                  "#dc3545",
                  "#17a2b8",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      function renderOrganizationsChart() {
        const orgCount = {};
        reservations.forEach((r) => {
          orgCount[r.organization] = (orgCount[r.organization] || 0) + 1;
        });

        const sortedOrgs = Object.entries(orgCount)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 6);

        const ctx = document
          .getElementById("organizationsChart")
          .getContext("2d");
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: sortedOrgs.map(([name]) => name),
            datasets: [
              {
                data: sortedOrgs.map(([, count]) => count),
                backgroundColor: [
                  "#4723d9",
                  "#28a745",
                  "#ffc107",
                  "#dc3545",
                  "#17a2b8",
                  "#6f42c1",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function renderAcademicChart() {
        const academicCount = reservations.filter(
          (r) => r.type === "academic"
        ).length;
        const nonAcademicCount = reservations.filter(
          (r) => r.type === "non-academic"
        ).length;

        const ctx = document.getElementById("academicChart").getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Academic", "Non-Academic"],
            datasets: [
              {
                data: [academicCount, nonAcademicCount],
                backgroundColor: ["#28a745", "#ffc107"],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // Generate and download reports
      async function generateReports() {
        try {
          // Ensure we have the latest data
          await loadData();

          const timestamp = new Date().toISOString().split("T")[0];

          // Create comprehensive report data
          const reportData = reservations.map((reservation) => {
            // Find corresponding facility details
            const facility = facilities.find(
              (f) => f.name === reservation.facility
            );

            return {
              "Reservation ID": reservation.id,
              "Event Name": reservation.eventName,
              Facility: reservation.facility,
              "Facility Capacity": facility ? facility.capacity : "N/A",
              "Facility Type": facility ? facility.type : "N/A",
              Organization: reservation.organization,
              "Start Date & Time": new Date(
                reservation.startTime
              ).toLocaleString(),
              "End Date & Time": new Date(reservation.endTime).toLocaleString(),
              "Duration (Hours)":
                Math.round(
                  ((new Date(reservation.endTime) -
                    new Date(reservation.startTime)) /
                    (1000 * 60 * 60)) *
                    100
                ) / 100,
              Status: reservation.status,
              "Person In Charge": reservation.personInCharge,
              "Event Type": reservation.type,
              "Created Date": reservation.createdAt
                ? new Date(reservation.createdAt).toLocaleString()
                : "N/A",
            };
          });

          // Convert to CSV
          const headers = Object.keys(reportData[0] || {});
          const csvRows = [];

          // Add headers
          csvRows.push(headers.join(","));

          // Add data rows
          reportData.forEach((row) => {
            const values = headers.map((header) => {
              const value = row[header];
              // Handle values that might contain commas or quotes
              return typeof value === "string" &&
                (value.includes(",") || value.includes('"'))
                ? `"${value.replace(/"/g, '""')}"`
                : value;
            });
            csvRows.push(values.join(","));
          });

          // Create and download file
          const csvString = csvRows.join("\n");
          const blob = new Blob([csvString], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);

          const link = document.createElement("a");
          link.href = url;
          link.download = `facility_reservations_report_${timestamp}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Clean up
          URL.revokeObjectURL(url);

          // Show success message
          alert("Report generated successfully!");
        } catch (error) {
          console.error("Error generating report:", error);
          alert("Error generating report. Please try again.");
        }
      }
    </script>
  </body>
</html>
