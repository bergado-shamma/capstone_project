<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Property Reservation</title>
    <link rel="stylesheet" href="student_equipment.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="icon" href="data:," />
  </head>
  <body>
    <!-- Burger Menu Button -->
    <div class="burger-menu" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </div>

    <div class="sidebar">
      <div class="logo">
        <img src="/assets/puplogo.png" alt="Logo Image" class="logo-img" />
        <span class="logo-text">PRFS</span>
      </div>
      <nav>
        <ul>
          <li>
            <i class="fas fa-home"></i> <span class="menu-text">Home</span>
          </li>
          <li>
            <i class="fas fa-calendar-check"></i>
            <span class="menu-text">Reservation Record</span>
          </li>
          <li>
            <i class="fas fa-user-cog"></i>
            <span class="menu-text">Manage Account</span>
          </li>
        </ul>
      </nav>
      <button class="logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div class="content">
      <h1>PUP TAGUIG PROPERTY & FACILITY RESERVATION</h1>

      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="step active">Choose Facility</div>
        <div class="step">Choose Equipment</div>
        <div class="step">Review & Submit</div>
        <div class="step">Confirmation</div>
      </div>

      <div class="reservation-table">
        <h2><em>Available Property</em></h2>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Quantity</th>
              <th>Asset</th>
              <th>Add</th>
            </tr>
          </thead>
          <tbody id="property-table-body"></tbody>
        </table>

        <h2>Added Asset</h2>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Asset</th>
              <th>Item Inserted</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody id="added-asset-table"></tbody>
        </table>

        <a href="Reservation_Details.html">
          <button class="confirm-btn">CONFIRMED</button>
        </a>
      </div>
    </div>

    <!-- PocketBase + Scripts -->
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <script>
      const pb = new PocketBase("http://127.0.0.1:8090");

      const availableTable = document.getElementById("property-table-body");
      const addedTable = document.getElementById("added-asset-table");

      let addedAssets = JSON.parse(sessionStorage.getItem("addedAssets")) || {};

      async function loadProperties() {
        try {
          const records = await pb
            .collection("property_tbl")
            .getFullList({ sort: "name" });

          availableTable.innerHTML = "";

          records.forEach((item, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${item.quantity}</td>
              <td>${item.name}</td>
              <td><button class="add-btn" data-id="${item.id}">+</button></td>
            `;
            availableTable.appendChild(row);
          });

          document.querySelectorAll(".add-btn").forEach((btn) => {
            btn.addEventListener("click", async function () {
              const propertyId = this.dataset.id;
              const record = await pb
                .collection("property_tbl")
                .getOne(propertyId);

              if (record.quantity > 0) {
                await pb.collection("property_tbl").update(propertyId, {
                  quantity: record.quantity - 1,
                });
                updateAddedAssets(record.name);
                loadProperties(); // Refresh available list
              } else {
                alert("No more quantity left!");
              }
            });
          });
        } catch (err) {
          console.error("‚ùå Error loading properties:", err.message);
        }
      }

      function updateAddedAssets(name) {
        if (!addedAssets[name]) {
          addedAssets[name] = 1;
        } else {
          addedAssets[name]++;
        }

        sessionStorage.setItem("addedAssets", JSON.stringify(addedAssets));
        renderAddedAssets();
      }

      function renderAddedAssets() {
        addedTable.innerHTML = "";
        let count = 1;

        for (const [name, quantity] of Object.entries(addedAssets)) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${count++}</td>
            <td>${name}</td>
            <td>${quantity}</td>
            <td><button class="remove-btn" data-name="${name}">Remove</button></td>
          `;
          addedTable.appendChild(row);
        }

        document.querySelectorAll(".remove-btn").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const name = this.dataset.name;
            const items = await pb
              .collection("property_tbl")
              .getFullList({ filter: `name="${name}"` });

            if (items.length > 0) {
              const item = items[0];
              if (addedAssets[name] > 1) {
                addedAssets[name]--;
                sessionStorage.setItem(
                  "addedAssets",
                  JSON.stringify(addedAssets)
                );
              } else {
                delete addedAssets[name];
                sessionStorage.setItem(
                  "addedAssets",
                  JSON.stringify(addedAssets)
                );
              }

              // Deduct only one item from the quantity
              await pb.collection("property_tbl").update(item.id, {
                quantity: item.quantity + 1,
              });

              renderAddedAssets();
              loadProperties();
            }
          });
        });
      }

      loadProperties();
      renderAddedAssets();
    </script>

    <script src="student_equipment.js"></script>
  </body>
</html>
